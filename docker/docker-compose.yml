# 国内服务器部署时镜像源记得换成 1ms 镜像
services:
  postgres:
    image: postgres:16-alpine
    container_name: areyouok-postgres
    restart: unless-stopped
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: areyouok
      PGDATA: /var/lib/postgresql/data/pgdata
    ports:
      - "5432:5432"
    volumes: 
      - postgres_data:/var/lib/postgresql/data
      - ../docs/schema.sql:/docker-entrypoint-initdb.d/01-schema.sql:ro   #作为第一版的数据库
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 5s
      timeout: 5s
      retries: 5
    networks:
      - areyouok-network

  
  redis:
    image: redis:7.4-alpine
    container_name: areyouok-redis
    restart: unless-stopped
    command: redis-server --appendonly yes
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5
    networks:
      - areyouok-network

  rabbitmq:
    build:
      context: ./rabbitmq
      dockerfile: Dockerfile
    container_name: areyouok-rabbitmq
    restart: unless-stopped
    environment:
      RABBITMQ_DEFAULT_USER: guest
      RABBITMQ_DEFAULT_PASS: guest
      RABBITMQ_DEFAULT_VHOST: /
    ports:
      - "5672:5672"   
      - "15672:15672" 
    volumes:
      - rabbitmq_data:/var/lib/rabbitmq
    healthcheck:
      test: ["CMD", "rabbitmq-diagnostics", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - areyouok-network

  api:
    build:
      context: ..
      dockerfile: docker/api/Dockerfile
    container_name: areyouok-api
    restart: unless-stopped
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    # 加载外部 .env 文件到环境变量
    # 注意：如果 .env.api 不存在，docker-compose 会报错
    env_file:
      - ../.env.api
    environment:
      # 服务配置（从 .env.api 加载）
      # SERVICE_NAME, ENVIRONMENT, SERVER_HOST, SERVER_PORT

      # 数据库配置（从 .env.api 加载）
      # POSTGRESQL_HOST=postgres 等

      # Redis 配置（从 .env.api 加载）
      # REDIS_ADDR=redis:6379 等

      # RabbitMQ 配置（从 .env.api 加载）
      # RABBITMQ_ADDR=rabbitmq 等

      # Snowflake 配置（从 .env.api 加载）
      # SNOWFLAKE_MACHINE_ID=1 等

      # 加密配置（从 .env.api 加载）
      # ENCRYPTION_KEY, JWT_SECRET 等

      # 日志配置（从 .env.api 加载）
      # LOGGER_LEVEL, LOGGER_FORMAT 等

      # Infrastructure endpoints
      OTEL_EXPORTER_OTLP_ENDPOINT: ${OTEL_EXPORTER_OTLP_ENDPOINT:-http://otel-collector:4317}
      PROM_METRICS_ADDR: ${PROM_METRICS_ADDR:-:9464}
    # 将外部 .env 文件映射到容器内的 .env（如果应用需要读取文件）
    # 优先使用 .env.api，如果不存在会报错，可以创建符号链接：ln -s .env .env.api
    volumes:
      - ../.env.api:/app/.env:ro
    ports:
      - "8080:8080"
    networks:
      - areyouok-network

  worker:
    build:
      context: ..
      dockerfile: docker/worker/Dockerfile
    container_name: areyouok-worker
    restart: unless-stopped
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    # 加载外部 .env 文件到环境变量
    # 注意：如果 .env.worker 不存在，docker-compose 会报错
    env_file:
      - ../.env.worker
    environment:
      # 服务配置（从 .env.worker 加载）
      # SERVICE_NAME, ENVIRONMENT 等

      # 数据库配置（从 .env.worker 加载）
      # POSTGRESQL_HOST=postgres, POSTGRESQL_PORT=5432 等

      # Redis 配置（从 .env.worker 加载）
      # REDIS_ADDR=redis:6379 等

      # RabbitMQ 配置（从 .env.worker 加载）
      # RABBITMQ_ADDR=rabbitmq 等

      # Snowflake 配置（从 .env.worker 加载）
      # SNOWFLAKE_MACHINE_ID=2 等

      # 加密密钥（从 .env.worker 加载）
      # ENCRYPTION_KEY, PHONEHASH_SALT 等

      # 日志配置（从 .env.worker 加载）
      # LOGGER_LEVEL, LOGGER_FORMAT 等

      # SMS 配置（从 .env.worker 加载）
      # SMS_PROVIDER, ALIBABA_CLOUD_ACCESS_KEY_ID, SMS_SIGN_NAME 等

      # Infrastructure endpoints (can be overridden here if needed)
      OTEL_EXPORTER_OTLP_ENDPOINT: ${OTEL_EXPORTER_OTLP_ENDPOINT:-http://otel-collector:4317}
      PROM_METRICS_ADDR: ${PROM_METRICS_ADDR:-:9464}
    # 将外部 .env 文件映射到容器内的 .env（如果应用需要读取文件）
    # 优先使用 .env.worker，如果不存在会报错，可以创建符号链接：ln -s .env .env.worker
    volumes:
      - ../.env.worker:/app/.env:ro
    networks:
      - areyouok-network
    # Worker 服务可以启动多个实例, 这里需要注意 worker 中对于 machine id 的配置
    deploy:
      replicas: 1

  otel-collector:
    image: otel/opentelemetry-collector-contrib:0.128.0
    container_name: areyouok-otel-collector
    command: ["--config=/etc/otel-collector-config.yaml"]
    volumes:
      - ./otel-collector-config.yaml:/etc/otel-collector-config.yaml:ro
    ports:
      - "4317:4317"   # OTLP gRPC receiver
      - "4318:4318"   # OTLP HTTP receiver
      - "8888:8888"   # Prometheus metrics endpoint
      - "8889:8889"   # Collector internal metrics
      - "13133:13133" # Health check
    depends_on:
      - jaeger
      - prometheus
      - loki
    networks:
      - areyouok-network

  jaeger:
    image: jaegertracing/all-in-one:1.52
    container_name: areyouok-jaeger
    environment:
      - COLLECTOR_OTLP_ENABLED=true
    ports:
      - "16686:16686" # UI
      - "14268:14268" # HTTP collector
      - "14250:14250" # gRPC collector
    networks:
      - areyouok-network

  loki:
    image: grafana/loki:2.9.0
    container_name: areyouok-loki
    command: -config.file=/etc/loki/local-config.yaml
    ports:
      - "3100:3100"
    volumes:
      - ./loki-config.yaml:/etc/loki/local-config.yaml:ro
      - loki_data:/loki
    networks:
      - areyouok-network

  prometheus:
    image: prom/prometheus:v2.45.0
    container_name: areyouok-prometheus
    command:
      - "--config.file=/etc/prometheus/prometheus.yml"
      - "--storage.tsdb.path=/prometheus"
    volumes:
      - ./prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - prometheus_data:/prometheus
    ports:
      - "9090:9090"
    networks:
      - areyouok-network

  grafana:
    image: grafana/grafana:10.1.0
    container_name: areyouok-grafana
    environment:
      GF_SECURITY_ADMIN_USER: ${GRAFANA_ADMIN_USER:-admin}
      GF_SECURITY_ADMIN_PASSWORD: ${GRAFANA_ADMIN_PASSWORD:-admin}
    volumes:
      - grafana_data:/var/lib/grafana
    ports:
      - "3000:3000"
    depends_on:
      - prometheus
    networks:
      - areyouok-network

volumes:
  postgres_data:
    driver: local
  redis_data:
    driver: local
  rabbitmq_data:
    driver: local
  prometheus_data:
    driver: local
  grafana_data:
    driver: local
  loki_data:
    driver: local

networks:
  areyouok-network:
    driver: bridge
